---
--- Generated by yuhang_lightpaw
--- Created by Administrator.
--- DateTime: 2024/9/24 20:26
--- 目标：完成陆行鸟喂食小游戏
---

local LuaClass = require("Core/LuaClass")
local TargetBase = require("Game/Quest/BasicClass/TargetBase")
local EventID = require("Define/EventID")
local UIViewMgr = require("UI/UIViewMgr")
local UIViewID = require("Define/UIViewID")
local MsgBoxUtil = require("Utils/MsgBoxUtil")
local ChocoboDefine = require("Game/Chocobo/ChocoboDefine")
local ClientGlobalCfg = require("TableCfg/ClientGlobalCfg")
local ProtoRes = require("Protocol/ProtoRes")
local NpcCfg = require("TableCfg/NpcCfg")
local ChocoboTransportDefine = require("Game/Chocobo/Transport/ChocoboTransportDefine")
local DataReportUtil = require("Utils/DataReportUtil")
local MajorUtil = require("Utils/MajorUtil")
local ProtoCommon = require("Protocol/ProtoCommon")
local MsgTipsUtil = require("Utils/MsgTipsUtil")

---@class TargetChocoboFeedingQte
local TargetChocoboFeedingQte = LuaClass(TargetBase, true)

function TargetChocoboFeedingQte:Ctor(_, Properties)
    self.GameID = tonumber(Properties[1]) or 0
end

function TargetChocoboFeedingQte:DoStartTarget()
    -- [sammrli] 体验优化
    local StateCom = MajorUtil.GetMajorStateComponent()
    if StateCom then
        if StateCom:IsInNetState(ProtoCommon.CommStatID.COMM_STAT_COMBAT) then
            MsgTipsUtil.ShowTipsByID(109702) --109702("战斗状态下，无法进行该操作")
             _G.QuestMgr:SendTargetRevert(self.TargetID)
            return
        end
    end

    self:RegisterEvent(EventID.PWorldMapEnter, self.OnGameEventPWorldMapEnter)
    
    local SureCallBack = function(_, Params)
        local IsNeverAgain = Params.IsNeverAgain
        if IsNeverAgain then
            ChocoboTransportDefine.TargetChocoboFeeNeverMindTipSelect = 1
        end

        self:RegisterEvent(EventID.ChocoboFeedingQteFinishNotify, self.OnChocoboFeedingQteFinishNotifyHandle)
        --self:RegisterEvent(EventID.ChocoboFeedingQteRevert, self.OnChocoboFeedingQteRevert)
        UIViewMgr:ShowView(UIViewID.ChocoboFeeDingMainPanelView, {GameID = self.GameID})
    end
    local CancleCallBack = function()
        _G.EventMgr:SendEvent(EventID.ChocoboFeedingQteFinishNotify, {
            GameID = self.GameID,
            GameResult = ChocoboDefine.CHOCOBO_FEE_QTE_RESULT.SKIP
        })
        DataReportUtil.ReportData("ChocoboQTEFlow", true, false, true,
        "GameID", tostring(self.GameID),
        "GameType", "2",
        "Result", "2",
        "Arg1", tostring(self.QuestID))
        _G.QuestMgr:SendFinishTarget(self.QuestID, self.TargetID)
    end
    
    local Name = ""
    local TableData = ClientGlobalCfg:FindCfgByKey(ProtoRes.client_global_cfg_id.GLOBAL_CFG_CHOCOBO_TRANSPORT_QTE_NPCID)
    if TableData ~= nil then
        local NpcID = TableData.Value[1] or 0
        local Cfg = NpcCfg:FindCfgByKey(NpcID)
        if Cfg ~= nil then
            Name = Cfg.Name
        end
    end
    
    local Content = string.format(_G.LSTR(440006), Name)
    if ChocoboTransportDefine.TargetChocoboFeeNeverMindTipSelect == 1 then
        self:RegisterEvent(EventID.ChocoboFeedingQteFinishNotify, self.OnChocoboFeedingQteFinishNotifyHandle)
        UIViewMgr:ShowView(UIViewID.ChocoboFeeDingMainPanelView, {GameID = self.GameID})
    else
        MsgBoxUtil.ShowMsgBoxTwoOp(nil, "", Content, SureCallBack, CancleCallBack, nil, nil,
                {
                    CloseClickCB = CancleCallBack,
                    bUseNever = true,
                    NeverMindText = _G.LSTR(440007),
                })
    end
end

function TargetChocoboFeedingQte:OnChocoboFeedingQteFinishNotifyHandle(Params)
    if Params then
        if self.GameID == Params.GameID then
            _G.QuestMgr:SendFinishTarget(self.QuestID, self.TargetID)
        end
    end
end

function TargetChocoboFeedingQte:OnChocoboFeedingQteRevert(Params)
    if Params and Params.GameID == self.GameID then
        _G.QuestMgr:SendTargetRevert(self.TargetID)
    end
end

-- 为了解決断线重连，被拉入副本，这两种异常关闭界面得情况
function TargetChocoboFeedingQte:OnGameEventPWorldMapEnter(Params)
    if Params and not Params.bReconnect then
        _G.QuestMgr:SendTargetRevert(self.TargetID)
    end
end

return TargetChocoboFeedingQte