---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2025/1/2 19:02
---

local LuaClass = require("Core/LuaClass")
local ProtoRes = require("Protocol/ProtoRes")
local ActorUtil = require("Utils/ActorUtil")
local BandCmdBase = require("Game/TouringBand/BandTimelineExtension/BandCmd/BandCmdBase")
local TouringBandUtil = require("Game/TouringBand/TouringBandUtil")
local AnimationUtil = require("Utils/AnimationUtil")

local BandCmdPlayAtl = LuaClass(BandCmdBase)

function BandCmdPlayAtl:OnInit()
    self.Name = "BandCmdPlayAtl"
    self.EventType = ProtoRes.TOURING_BAND_TIMELINE_EVENT_SUB_TYPE.TB_SUB_ANIMATION
    self.EntityID = 0
    self.NpcActor = nil
    self.IsPlaying = false
end

function BandCmdPlayAtl:SetEntityID(InEntityID)
    self.EntityID = InEntityID
end

function BandCmdPlayAtl:OnStart()
    if self.Param == nil then
        TouringBandUtil.Err("BandCmdPlayAtl.OnStart Failed ID =  : " .. self.ID)
        return
    end

    self.NpcActor = ActorUtil.GetActorByEntityID(self.EntityID)
    if self.NpcActor == nil then
        TouringBandUtil.Err("BandCmdPlayAtl.OnStart Failed: Invalid self.NpcActor")
        return
    end

    local AttrComp = self.NpcActor:GetAttributeComponent()
    if AttrComp == nil then
        TouringBandUtil.Err("BandCmdPlayAtl.OnStart Failed: Invalid AttrComp")
        return
    end

    self.AnimComp = self.NpcActor:GetAnimationComponent()
    if self.AnimComp == nil then
        return
    end

    self.AtlID = self.Param[1] or 0
    self.IsPlaying = false
end

function BandCmdPlayAtl:OnUpdate(DeltaTime)
    if self.IsPlaying then
        return
    end

    if self.NpcActor == nil then
        return
    end

    if self.AnimComp == nil then
        return
    end

    local Montage = self.AnimComp:PlayActionTimeline(self.AtlID, self.PlayRate)
    local AnimInst = self.AnimComp:GetAnimInstance()
    self.IsPlaying = true

    -- 调整播放进度
    if self.IsMidPlayback then
        if _G.UE.UCommonUtil.IsObjectValid(Montage) and _G.UE.UCommonUtil.IsObjectValid(AnimInst) then
            local Length = AnimationUtil.GetAnimMontageLength(Montage)
            local InputTime = self.CurrentTime - self.StartTime
            local Repetitions = math.floor(InputTime / Length)
            local RemainingTime = InputTime - (Repetitions * Length)
            local Position = math.floor(((RemainingTime / Length) * 100) + 0.5) * 0.01
            AnimationUtil.SetMontagePosition(AnimInst, Montage, Position)
        end
    end
end

return BandCmdPlayAtl