---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/12/31 16:35
---

local LuaClass = require("Core/LuaClass")
local ProtoRes = require ("Protocol/ProtoRes")
local ActorUtil = require("Utils/ActorUtil")
local BandCmdBase = require("Game/TouringBand/BandTimelineExtension/BandCmd/BandCmdBase")
local TouringBandUtil = require("Game/TouringBand/TouringBandUtil")
local TouringBandDefine = require("Game/TouringBand/TouringBandDefine")
local EventID = require("Define/EventID")

local BandCmdShowWeaponSystem = LuaClass(BandCmdBase)

function BandCmdShowWeaponSystem:OnInit()
    self.Name = "BandCmdShowWeaponSystem"
    self.EventType = ProtoRes.TOURING_BAND_TIMELINE_EVENT_PARENT_TYPE.TB_EVENT_SUB_SHOW_WEAPON
end

function BandCmdShowWeaponSystem:OnStart()
    if self.StringParam == nil then
        TouringBandUtil.Err("BandCmdCreateNpcClip.OnStart Create Failed ID =  : " .. self.ID)
        return
    end

    local Timeline = _G.BandTimelineMgr:GetTimelineByID(self.TimelineID)
    if not Timeline then
        TouringBandUtil.Err("BandCmdCreateNpcClip.OnStart Failed: Timeline not found for ID = " .. tostring(self.TimelineID))
        return
    end
    
    local Member = Timeline:GetMemberEntityIDList()
    local EntityID = Member[self.TargetIndex]
    if EntityID <= 0 then
        TouringBandUtil.Err("BandCmdCreateNpcClip.OnStart Failed: Invalid EntityID (0) at Index = " .. tostring(self.TargetIndex))
        return
    end
    
    local ModelID = self.StringParam[1]
    local AvatarComp = ActorUtil.GetActorAvatarComponent(EntityID)
    if AvatarComp then
        if string.isnilorempty(ModelID) then
            Timeline:SetModelWeaponList(self.TargetIndex, "")
            AvatarComp:SetAvatarHiddenInGame(_G.UE.EAvatarPartType.WEAPON_SYSTEM, true, false, false)
            _G.EventMgr:SendEvent(EventID.TouringBandStatesChange, { TimelineID = Timeline.TimelineID, Key = TouringBandDefine.STATES_TYPE.SHOW_SYSTEM_WEAPON , Value = false })
        else
            local ModelParams = string.split(ModelID, ",")
            if #ModelParams >= 3 then
                local ModelPath = string.format("w%04d", tonumber(ModelParams[1]))
                local SubModelPath = string.format("b%04d", tonumber(ModelParams[2]))
                local ImagechangeID = tonumber(ModelParams[3])
                AvatarComp:SetAvatarHiddenInGame(_G.UE.EAvatarPartType.WEAPON_SYSTEM, false, false, false)
                AvatarComp:ChangeAvatarWeapon(ModelPath, SubModelPath, ImagechangeID, 0, _G.UE.EAvatarPartType.WEAPON_SYSTEM, 0)
            end
            Timeline:SetModelWeaponList(self.TargetIndex, ModelID)
            _G.EventMgr:SendEvent(EventID.TouringBandStatesChange, { TimelineID = Timeline.TimelineID, Key = TouringBandDefine.STATES_TYPE.SHOW_SYSTEM_WEAPON , Value = true })
        end
    end
end

function BandCmdShowWeaponSystem:OnTriggerEventAfterStartTime()
    self:OnStart()
end

return BandCmdShowWeaponSystem