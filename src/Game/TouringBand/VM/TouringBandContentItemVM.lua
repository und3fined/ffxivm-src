
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2024/7/8 15:56
---

local LuaClass = require("Core/LuaClass")
local UIViewModel = require("UI/UIViewModel")
local TouringBandCfg = require("TableCfg/TouringBandCfg")
local EmotionCfg = require("TableCfg/EmotionCfg")
local CompanionCfg = require("TableCfg/CompanionCfg")
local ProtoCS = require ("Protocol/ProtoCS")

local TouringBandMgr = nil
local LSTR = nil

---@type TouringBandContentItemVM : UIViewModel
local TouringBandContentItemVM = LuaClass(UIViewModel)

function TouringBandContentItemVM:Ctor()
    TouringBandMgr = _G.TouringBandMgr
    LSTR = _G.LSTR
    self:Reset()
end

function TouringBandContentItemVM:Reset()
    self.TextContent = ""
    self.TextCondition = ""
    self.IsShowPanelLock = false
    self.TextLock = ""
    self.TextExterior = ""
    self.TextEPet = ""
    self.TextAction = ""
    self.IsShowPanelCondition = false
    self.IsShowExterior = false
    self.IsShowEPet = false
    self.IsShowAction = false
    self.IsExteriorLock = false
    self.IsPetLock = false
    self.IsActionLock = false
end

function TouringBandContentItemVM:UpdateContent(BandID)
    self:Reset()
    local BandCfg = TouringBandCfg:FindCfgByKey(BandID)
    if BandCfg == nil then return end
    
    self.TextContent = BandCfg.BandDisplay
end

function TouringBandContentItemVM:UpdateStory(BandID, Index)
    self:Reset()
    local BandCfg = TouringBandCfg:FindCfgByKey(BandID)
    if BandCfg == nil then return end
    if BandCfg.StoryContent == nil then return end
    if BandCfg.StoryListens == nil then return end
    
    local Content = BandCfg.StoryContent[Index]
    local MaxListens = BandCfg.StoryListens[Index]

    local CheeringNum = TouringBandMgr:GetBandCheeringNum(BandID)
    if MaxListens ~= nil then
        if CheeringNum >= MaxListens then
            self.IsShowPanelLock = false
            self.TextContent = Content
        else
            self.IsShowPanelLock = true
            -- LSTR string: 聆听%d次后解锁
            self.TextLock = string.format(LSTR(450011), MaxListens)
        end
    end
end

function TouringBandContentItemVM:UpdateGuideCondition(BandID)
    self:Reset()
    local BandCfg = TouringBandCfg:FindCfgByKey(BandID)
    if BandCfg == nil then return end

    local BandData = TouringBandMgr:GetBandDataByID(BandID)
    if BandData == nil then
        return
    end
    
    -- LSTR string: 达成以下任意条件，可解锁歌曲：
    self.TextCondition = LSTR(450012)
    self.TextExterior = "? ? ? ?"
    self.TextEPet = "? ? ? ?"
    self.TextAction = "? ? ? ?"
    
    self.TextExteriorColor = "6c6964FF"
    self.TextEPetColor = "6c6964FF"
    self.TextActionColor = "6c6964FF"
    
    self.IsShowPanelCondition = true
    -- 达成的解锁条件
    self.IsExteriorLock = false
    self.IsPetLock = false
    self.IsActionLock = false

    local AppearanceIDs = BandCfg.AppearanceIDs
    local PetID = BandCfg.PetID
    local EmotionID = BandCfg.EmotionID

    -- 所有解锁条件
    self.IsShowExterior = #AppearanceIDs > 0  
    self.IsShowEPet = PetID > 0
    self.IsShowAction = EmotionID > 0
    
    if BandData.InteractRecords ~= nil then
        for Key, Value in pairs(BandData.InteractRecords) do
            if Key == ProtoCS.Game.TouringBand.ReportType.Emotion then
                self.IsActionLock = Value > 0
            elseif Key == ProtoCS.Game.TouringBand.ReportType.Equip then
                self.IsExteriorLock = Value > 0
            elseif Key == ProtoCS.Game.TouringBand.ReportType.Companion then
                self.IsPetLock = Value > 0
            elseif Key == ProtoCS.Game.TouringBand.ReportType.Appearance then
                self.IsExteriorLock = Value > 0
            end
        end
    end
    
    local IsFans = TouringBandMgr:IsBandFansByID(BandID)
    if IsFans then
        -- LSTR string: 已成为粉丝，歌曲已解锁
        self.TextCondition = LSTR(450013)

        if self.IsShowExterior then
            if self.IsExteriorLock then
                self.TextExteriorColor = "313131FF"
            end
            self.TextExterior = BandCfg.AppearanceDesc or ""
        end

        if self.IsShowEPet then
            local PetCfg = CompanionCfg:FindCfgByKey(PetID)
            if PetCfg ~= nil then
                if self.IsPetLock then
                    self.TextEPetColor = "313131FF"
                end
                -- LSTR string: 携带%s
                self.TextEPet = string.format(LSTR(450015), PetCfg.Name)
            end
        end

        if self.IsShowAction then
            local Cfg = EmotionCfg:FindCfgByKey(EmotionID)
            if Cfg ~= nil then
                if self.IsActionLock then
                    self.TextActionColor = "313131FF"
                end
                -- LSTR string: 表达%s
                self.TextAction = string.format(LSTR(450016), Cfg.EmotionName)
            end
        end
    end
end

return TouringBandContentItemVM